'use client';

import { useState, useMemo, useEffect, useCallback } from 'react';
import {
  Target, TrendingUp, Plus, Download, DollarSign, Zap,
  ChevronDown, ChevronRight, Layers, X, Save, Loader2
} from 'lucide-react';
import { useScenarios } from '@/lib/hooks/useScenarios';
import { calculateMetrics, calculateFunnelMetrics, debounce } from '@/lib/utils';
import {
  ScenarioWithData, MONTHS, QUARTERS, SEGMENT_CONFIGS,
  GTM_COLORS, MASTER_GROUP_COLORS, SegmentType, GtmType, ScenarioType
} from '@/lib/types';

interface RevenuePlannerProps {
  scenarioId: string;
  userId: string;
}

export default function RevenuePlanner({ scenarioId, userId }: RevenuePlannerProps) {
  const [activeTab, setActiveTab] = useState<'output' | 'funnel'>('output');
  const [conversionRates, setConversionRates] = useState({
    SMB: { oppToClose: 25, avgDaysToClose: 60 },
    MM: { oppToClose: 20, avgDaysToClose: 90 },
    ENT: { oppToClose: 20, avgDaysToClose: 120 },
    'ENT+': { oppToClose: 10, avgDaysToClose: 180 },
    Flagship: { oppToClose: 10, avgDaysToClose: 180 },
  });

  const { scenarios, loading, error, saving, updateScenario, addGtmGroup, updateGtmGroup,
    deleteGtmGroup, addSegment, updateSegment, deleteSegment } = useScenarios(userId);

  const scenario = scenarios.find(s => s.id === scenarioId);
  const [localRps, setLocalRps] = useState(scenario?.rps || 40);
  const [localTargetShipments, setLocalTargetShipments] = useState(scenario?.target_shipments || 400000);

  useEffect(() => {
    if (scenario) {
      setLocalRps(scenario.rps);
      setLocalTargetShipments(scenario.target_shipments);
    }
  }, [scenario]);

  // Debounced save for RPS and target shipments
  const debouncedUpdateScenario = useCallback(
    debounce((id: string, updates: any) => {
      updateScenario(id, updates);
    }, 500),
    [updateScenario]
  );

  const handleRpsChange = (value: number) => {
    setLocalRps(value);
    if (scenario) {
      debouncedUpdateScenario(scenario.id, { rps: value });
    }
  };

  const handleTargetShipmentsChange = (value: number) => {
    setLocalTargetShipments(value);
    if (scenario) {
      debouncedUpdateScenario(scenario.id, { target_shipments: value });
    }
  };

  // Debounced segment update
  const debouncedUpdateSegment = useCallback(
    debounce((segmentId: string, updates: any) => {
      updateSegment(segmentId, updates);
    }, 500),
    [updateSegment]
  );

  const handleSegmentLaunchChange = (segmentId: string, launches: number[], monthIndex: number, value: string) => {
    const newLaunches = launches.map((v, i) => i === monthIndex ? parseInt(value) || 0 : v);
    debouncedUpdateSegment(segmentId, { launches: newLaunches });
  };

  const handleSegmentSpmChange = (segmentId: string, value: string) => {
    debouncedUpdateSegment(segmentId, { spm: parseInt(value) || 0 });
  };

  const calculations = useMemo(() => {
    if (!scenario) return null;
    return calculateMetrics([scenario], localRps, localTargetShipments, conversionRates);
  }, [scenario, localRps, localTargetShipments, conversionRates]);

  const funnelCalculations = useMemo(() => {
    if (!scenario) return null;
    return calculateFunnelMetrics([scenario], conversionRates);
  }, [scenario, conversionRates]);

  const exportToCSV = () => {
    if (!scenario || !calculations) return;

    const rows = [];
    rows.push(['Scenario', 'GTM Motion', 'Segment', 'SPM', ...MONTHS, 'Total Shipments', 'Realized Revenue', 'ARR']);

    scenario.gtm_groups.forEach(gtmGroup => {
      gtmGroup.segments.forEach((seg, idx) => {
        rows.push([
          idx === 0 ? scenario.name : '',
          idx === 0 ? gtmGroup.name : '',
          seg.segment_type,
          seg.spm,
          ...seg.launches,
          calculations.segmentTotals[seg.id],
          `$${calculations.segmentRevenueBreakdown[seg.id]?.realized.toLocaleString()}`,
          `$${calculations.segmentRevenueBreakdown[seg.id]?.arr.toLocaleString()}`
        ]);
      });
    });

    rows.push([
      `${scenario.name} Total`,
      '', '', '',
      ...Array(12).fill(''),
      calculations.masterGroupTotals[scenario.id],
      `$${calculations.masterGroupRevenueBreakdown[scenario.id]?.realized.toLocaleString()}`,
      `$${calculations.masterGroupRevenueBreakdown[scenario.id]?.arr.toLocaleString()}`
    ]);

    const csvContent = rows.map(row => row.join(',')).join('\n');
    const blob = new Blob([csvContent], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `gtm-revenue-plan-${scenario.name}-${new Date().toISOString().split('T')[0]}.csv`;
    a.click();
    window.URL.revokeObjectURL(url);
  };

  if (loading) {
    return (
      <div className="min-h-screen bg-gray-50 flex items-center justify-center">
        <div className="text-center">
          <Loader2 className="w-12 h-12 text-blue-600 animate-spin mx-auto mb-4" />
          <p className="text-gray-600">Loading scenario...</p>
        </div>
      </div>
    );
  }

  if (error) {
    return (
      <div className="min-h-screen bg-gray-50 flex items-center justify-center">
        <div className="text-center">
          <p className="text-red-600 mb-4">{error}</p>
        </div>
      </div>
    );
  }

  if (!scenario) {
    return (
      <div className="min-h-screen bg-gray-50 flex items-center justify-center">
        <div className="text-center">
          <p className="text-gray-600">Scenario not found</p>
        </div>
      </div>
    );
  }

  if (!calculations || !funnelCalculations) return null;

  return (
    <div className="min-h-screen bg-gray-50 p-6">
      <div className="max-w-[1600px] mx-auto">
        {/* Header */}
        <div className="mb-6">
          <div className="flex items-center justify-between mb-3">
            <div>
              <h1 className="text-3xl font-bold text-gray-900 mb-1">
                {scenario.name}
              </h1>
              <div className="flex items-center gap-4">
                <p className="text-gray-600 text-sm">
                  Plan by GTM motion
                </p>
                <div className="flex items-center gap-2">
                  <label className="text-sm font-semibold text-gray-700">Target:</label>
                  <input
                    type="number"
                    value={localTargetShipments}
                    onChange={(e) => handleTargetShipmentsChange(parseInt(e.target.value) || 0)}
                    className="w-32 px-2 py-1 text-sm border border-gray-300 rounded bg-white font-semibold"
                    min="0"
                  />
                  <span className="text-sm text-gray-600">shipments</span>
                </div>
                <div className="flex items-center gap-2">
                  <label className="text-sm font-semibold text-gray-700">RPS:</label>
                  <div className="relative">
                    <span className="absolute left-2 top-1/2 -translate-y-1/2 text-gray-500 text-sm">$</span>
                    <input
                      type="number"
                      value={localRps}
                      onChange={(e) => handleRpsChange(parseFloat(e.target.value) || 0)}
                      className="w-20 pl-5 pr-2 py-1 text-sm border border-gray-300 rounded bg-white font-semibold"
                      min="0"
                      step="0.01"
                    />
                  </div>
                </div>
                {saving && (
                  <div className="flex items-center gap-2 text-sm text-blue-600">
                    <Save className="w-4 h-4 animate-pulse" />
                    <span>Saving...</span>
                  </div>
                )}
              </div>
            </div>
            <button
              onClick={exportToCSV}
              className="flex items-center gap-2 px-4 py-2 bg-gray-700 text-white rounded-lg hover:bg-gray-800 transition-colors text-sm"
            >
              <Download className="w-4 h-4" />
              Export CSV
            </button>
          </div>

          {/* Tabs */}
          <div className="flex gap-2">
            <button
              onClick={() => setActiveTab('output')}
              className={`px-6 py-3 rounded-lg font-semibold transition-colors ${
                activeTab === 'output'
                  ? 'bg-blue-600 text-white shadow-md'
                  : 'bg-white text-gray-700 hover:bg-gray-100'
              }`}
            >
              <div className="flex items-center gap-2">
                <Target className="w-4 h-4" />
                <span>Output View</span>
              </div>
            </button>
            <button
              onClick={() => setActiveTab('funnel')}
              className={`px-6 py-3 rounded-lg font-semibold transition-colors ${
                activeTab === 'funnel'
                  ? 'bg-blue-600 text-white shadow-md'
                  : 'bg-white text-gray-700 hover:bg-gray-100'
              }`}
            >
              <div className="flex items-center gap-2">
                <Zap className="w-4 h-4" />
                <span>Funnel Planning</span>
              </div>
            </button>
          </div>
        </div>

        {/* Goal Progress */}
        <div className="bg-white rounded-lg shadow p-5 mb-6">
          <div className="flex items-center justify-between mb-3">
            <div className="flex items-center gap-3">
              <Target className="w-7 h-7 text-blue-600" />
              <div>
                <h2 className="text-2xl font-bold text-gray-900">
                  {calculations.totalShipments.toLocaleString()}
                </h2>
                <p className="text-xs text-gray-600">Total Annual Shipments</p>
              </div>
            </div>
            <div className="text-right">
              <p className="text-2xl font-bold text-blue-600">
                {calculations.percentageToGoal.toFixed(1)}%
              </p>
              <p className="text-xs text-gray-600">of {localTargetShipments.toLocaleString()} goal</p>
            </div>
          </div>

          <div className="w-full bg-gray-200 rounded-full h-5 overflow-hidden mb-2">
            <div
              className="bg-gradient-to-r from-blue-500 to-blue-600 h-5 rounded-full transition-all duration-500 flex items-center justify-end pr-2"
              style={{ width: `${Math.min(calculations.percentageToGoal, 100)}%` }}
            >
              {calculations.percentageToGoal > 5 && (
                <span className="text-white text-xs font-semibold">
                  {calculations.totalShipments.toLocaleString()}
                </span>
              )}
            </div>
          </div>

          {calculations.shortfall > 0 ? (
            <p className="text-sm text-orange-600 flex items-center gap-2">
              <TrendingUp className="w-4 h-4" />
              Need {calculations.shortfall.toLocaleString()} more shipments
            </p>
          ) : (
            <p className="text-sm text-green-600 flex items-center gap-2">
              <TrendingUp className="w-4 h-4" />
              Exceeding goal by {Math.abs(calculations.shortfall).toLocaleString()} shipments!
            </p>
          )}
        </div>

        {/* Revenue Summary */}
        <div className="bg-white rounded-lg shadow p-5 mb-6">
          <h3 className="text-lg font-bold text-gray-900 mb-3 flex items-center gap-2">
            <DollarSign className="w-5 h-5" />
            Revenue Projection @ ${localRps.toFixed(2)} per shipment
          </h3>
          <div className="grid grid-cols-3 gap-4">
            <div className="bg-gray-50 rounded-lg p-4 border-4 border-blue-700">
              <p className="text-xs font-semibold text-gray-600 mb-1">Annual Shipments</p>
              <p className="text-2xl font-bold text-gray-900">
                {calculations.totalShipments.toLocaleString()}
              </p>
            </div>
            <div className="bg-gray-50 rounded-lg p-4 border-4 border-blue-700">
              <p className="text-xs font-semibold text-gray-600 mb-1">Realized Revenue (Year 1)</p>
              <p className="text-2xl font-bold text-gray-900">
                ${calculations.realizedRevenue.toLocaleString()}
              </p>
              <p className="text-xs text-gray-500 mt-1">Actual revenue earned this year</p>
            </div>
            <div className="bg-gray-50 rounded-lg p-4 border-4 border-blue-700">
              <p className="text-xs font-semibold text-gray-600 mb-1">Annualized Run Rate (ARR)</p>
              <p className="text-2xl font-bold text-gray-900">
                ${calculations.annualizedRunRate.toLocaleString()}
              </p>
              <p className="text-xs text-gray-500 mt-1">Full-year revenue potential</p>
            </div>
          </div>
        </div>

        {/* Quarterly Summary */}
        <div className="bg-white rounded-lg shadow p-5 mb-6">
          <h3 className="text-lg font-bold text-gray-900 mb-3">Quarterly Breakdown</h3>
          <div className="grid grid-cols-4 gap-3">
            {Object.entries(calculations.quarterlyBreakdown).map(([quarter, shipments]) => (
              <div key={quarter} className="bg-gray-50 rounded-lg p-3 border-2 border-gray-200">
                <p className="text-sm font-semibold text-gray-600 mb-1">{quarter}</p>
                <p className="text-xl font-bold text-gray-900">
                  {(shipments / 3).toLocaleString(undefined, { maximumFractionDigits: 0 })}
                </p>
                <p className="text-xs text-gray-500">SPM avg</p>
              </div>
            ))}
          </div>
        </div>

        {/* GTM Groups */}
        <div className="space-y-6">
          {scenario.gtm_groups.map((gtmGroup, gtmIndex) => {
            const gtmColors = GTM_COLORS[gtmGroup.type as GtmType] || GTM_COLORS.Custom;
            const gtmFunnel = funnelCalculations.gtmGroupFunnelData[gtmGroup.id];

            return (
              <div key={gtmGroup.id} className="bg-white rounded-lg shadow-lg border-2 border-gray-300">
                {/* GTM Group Header */}
                <div className="bg-gray-100 p-4 flex items-center justify-between border-b-2 border-gray-300">
                  <div className="flex items-center gap-3 flex-1">
                    <button
                      onClick={() => updateGtmGroup(gtmGroup.id, { collapsed: !gtmGroup.collapsed })}
                      className="text-gray-700 hover:text-gray-900"
                    >
                      {gtmGroup.collapsed ? <ChevronRight className="w-5 h-5" /> : <ChevronDown className="w-5 h-5" />}
                    </button>
                    <input
                      type="text"
                      value={gtmGroup.name}
                      onChange={(e) => updateGtmGroup(gtmGroup.id, { name: e.target.value })}
                      className="text-lg font-bold text-gray-900 bg-transparent border-none focus:outline-none focus:ring-2 focus:ring-blue-700 rounded px-2 py-1"
                    />
                    <select
                      value={gtmGroup.type}
                      onChange={(e) => updateGtmGroup(gtmGroup.id, { type: e.target.value as GtmType })}
                      className="text-sm font-semibold text-gray-700 bg-white border border-gray-400 rounded px-2 py-1"
                    >
                      <option value="Sales">Sales</option>
                      <option value="Marketing">Marketing</option>
                      <option value="Partnerships">Partnerships</option>
                      <option value="Custom">Custom</option>
                    </select>
                  </div>

                  <div className="flex items-center gap-4">
                    {activeTab === 'output' ? (
                      <>
                        <div className="text-right">
                          <p className="text-xs text-gray-600">Shipments</p>
                          <p className="text-xl font-bold text-gray-900">
                            {calculations.gtmGroupTotals[gtmGroup.id]?.toLocaleString() || '0'}
                          </p>
                        </div>
                        <div className="text-right">
                          <p className="text-xs text-gray-600">Realized Revenue</p>
                          <p className="text-lg font-bold text-gray-900">
                            ${(calculations.gtmGroupRevenueBreakdown[gtmGroup.id]?.realized || 0).toLocaleString()}
                          </p>
                        </div>
                      </>
                    ) : (
                      <div className="text-right">
                        <p className="text-xs text-gray-600">Opportunities</p>
                        <p className="text-xl font-bold text-gray-900">
                          {gtmFunnel?.totalOpps?.toLocaleString() || '0'}
                        </p>
                      </div>
                    )}
                    <button
                      onClick={() => deleteGtmGroup(gtmGroup.id)}
                      className="p-2 text-red-600 hover:bg-red-50 rounded transition-colors"
                    >
                      <X className="w-5 h-5" />
                    </button>
                  </div>
                </div>

                {/* Segments */}
                {!gtmGroup.collapsed && (
                  <div className="p-4">
                    {gtmGroup.segments.map((segment) => {
                      const segmentConfig = SEGMENT_CONFIGS[segment.segment_type];
                      const segmentFunnel = funnelCalculations.segmentFunnelData[segment.id];

                      return (
                        <div key={segment.id} className="mb-4 last:mb-0">
                          <div className="flex items-center gap-3 mb-2">
                            <div className="px-3 py-1 bg-gray-200 text-gray-700 rounded-lg font-semibold text-sm border border-gray-400">
                              {segment.segment_type}
                            </div>
                            <div className="flex items-center gap-2">
                              <span className="text-sm text-gray-600">SPM:</span>
                              <input
                                type="number"
                                value={segment.spm}
                                onChange={(e) => handleSegmentSpmChange(segment.id, e.target.value)}
                                className="w-24 px-2 py-1 text-sm border border-gray-300 rounded"
                                min="0"
                              />
                            </div>
                            {activeTab === 'output' ? (
                              <>
                                <div className="text-sm text-gray-600">
                                  Total: <span className="font-bold text-gray-900">
                                    {calculations.segmentTotals[segment.id]?.toLocaleString() || '0'}
                                  </span> shipments
                                </div>
                                <div className="text-sm text-gray-600">
                                  Realized: <span className="font-bold text-gray-900">
                                    ${(calculations.segmentRevenueBreakdown[segment.id]?.realized || 0).toLocaleString()}
                                  </span>
                                </div>
                                <div className="text-sm text-gray-600">
                                  ARR: <span className="font-bold text-gray-900">
                                    ${(calculations.segmentRevenueBreakdown[segment.id]?.arr || 0).toLocaleString()}
                                  </span>
                                </div>
                              </>
                            ) : (
                              <div className="text-sm text-gray-600">
                                Opps: <span className="font-bold text-gray-900">
                                  {segmentFunnel?.totalOpps?.toLocaleString() || '0'}
                                </span>
                              </div>
                            )}
                            <button
                              onClick={() => deleteSegment(segment.id)}
                              className="ml-auto p-1 text-red-600 hover:bg-red-50 rounded"
                            >
                              <X className="w-4 h-4" />
                            </button>
                          </div>

                          {/* Monthly Input Grid */}
                          <div className="grid grid-cols-12 gap-1">
                            {MONTHS.map((month, monthIndex) => (
                              <div key={monthIndex}>
                                <label className="block text-xs text-gray-600 text-center mb-1">
                                  {month}
                                </label>
                                <input
                                  type="number"
                                  value={segment.launches[monthIndex]}
                                  onChange={(e) => handleSegmentLaunchChange(segment.id, segment.launches, monthIndex, e.target.value)}
                                  className="w-full px-1 py-1 text-sm text-center border border-gray-300 rounded"
                                  min="0"
                                />
                                {activeTab === 'funnel' && segmentFunnel && (
                                  <div className="text-xs text-purple-600 text-center mt-1">
                                    {segmentFunnel.monthlyOpps[monthIndex] || 0}
                                  </div>
                                )}
                              </div>
                            ))}
                          </div>
                        </div>
                      );
                    })}

                    {/* Add Segment Buttons */}
                    <div className="flex gap-2 mt-4 pt-4 border-t border-gray-200">
                      <span className="text-sm text-gray-600 font-semibold">Add Segment:</span>
                      {Object.entries(SEGMENT_CONFIGS).map(([type, config]) => (
                        <button
                          key={type}
                          onClick={() => addSegment(gtmGroup.id, type as SegmentType, config.defaultSPM)}
                          className="px-3 py-1 bg-gray-200 text-gray-700 border border-gray-400 rounded text-sm font-semibold hover:bg-gray-300 transition-colors"
                        >
                          + {config.label}
                        </button>
                      ))}
                    </div>
                  </div>
                )}
              </div>
            );
          })}

          {/* Add GTM Group Button */}
          <button
            onClick={() => addGtmGroup(scenario.id, 'New GTM Motion', 'Custom')}
            className="w-full py-4 border-2 border-dashed border-gray-300 rounded-lg text-gray-600 hover:border-blue-400 hover:text-blue-600 transition-colors flex items-center justify-center gap-2 font-semibold"
          >
            <Plus className="w-5 h-5" />
            Add GTM Motion
          </button>
        </div>
      </div>
    </div>
  );
}
